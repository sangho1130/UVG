---
title: "Correlation b/w malignant cluster and cell types"
output: html_notebook
---

```{r}
library(Seurat)
library(ggplot2)
library(reshape2)
library(plyr)
library(RColorBrewer)

#dir.create('../res_various/res_0.3/cluster_proportion')

myObj <- readRDS('../tmp/crc_smc.malignantcells.Rds')
myObj@meta.data$RNA_snn_res.0.3 <- paste('C', myObj@meta.data$RNA_snn_res.0.3, sep = '')
myObj@meta.data$RNA_snn_res.0.3 <- factor(myObj@meta.data$RNA_snn_res.0.3, levels = paste('C', c(0:7), sep = ''))
levels(myObj@meta.data$RNA_snn_res.0.3)
head(myObj@meta.data, n=3)
nrow(myObj@meta.data) # 17334

malignant <- myObj@meta.data
remove(myObj)

### Full data
fullObj <- readRDS('../tmp/crc_smc.full.Rds')
excludecells <- setdiff(rownames(subset(fullObj@meta.data, Cell_type == 'Malignant cells')), rownames(malignant)); length(excludecells) # 135

fullObj <- subset(fullObj, cells = setdiff(rownames(fullObj@meta.data), excludecells))
fullObj@meta.data$Cell_type_v2 <- mapvalues(fullObj@meta.data$Cell_subtype, from = levels(fullObj@meta.data$Cell_subtype),
                                            to = c("B cells", "Plasma cells", "Plasma cells", 
                                                   "T cells", "T cells", "T cells", "T cells", "T cells", "T cells", "T cells", 
                                                   "Macrophages", "Macrophages", "Macrophages", "cDC", "Mast cells", 
                                                   "Fibroblasts", "Fibroblasts", "Fibroblasts", "Fibroblasts", 
                                                   "Stromal cells", "Stromal cells", 
                                                   "Endothelial cells", "Stromal cells", "Endothelial cells", "Endothelial cells", "Endothelial cells", 
                                                   "Malignant cells", "Malignant cells", "Malignant cells", "Malignant cells", 
                                                   "Epithelial cells","Epithelial cells", "Epithelial cells", "Epithelial cells", "Epithelial cells"))
fullObj@meta.data$Cell_type_v2 <- factor(fullObj@meta.data$Cell_type_v2, 
                                         levels = c("Epithelial cells", "Malignant cells", "Macrophages", "cDC", "Mast cells", 
                                                    "B cells", "Plasma cells", "T cells", "Fibroblasts", "Stromal cells", "Endothelial cells"))
summary(fullObj@meta.data$Cell_type_v2)
head(fullObj@meta.data, n=3)

full_label <- fullObj@meta.data
remove(fullObj)


### Proportions of malignant clusters
malignant <- subset(malignant, `RNA_snn_res.0.3` != 'C7')
malignant <- droplevels(malignant)
levels(malignant$RNA_snn_res.0.3)

prop <- data.frame(matrix(nrow = length(unique(malignant$RNA_snn_res.0.3)), ncol = length(unique(malignant$Patient))))
colnames(prop) <- levels(malignant$Patient)
rownames(prop) <- levels(malignant$RNA_snn_res.0.3)
prop

for (pt in levels(malignant$Patient)) {
  summ <- summary(subset(malignant, Patient == pt)$RNA_snn_res.0.3)
  prop[, pt] <- round(summ/sum(summ)*100, digits = 2)
}
prop

prop_plot <- data.frame(Cluster = rownames(prop), prop)
prop_plot <- melt(prop_plot)
prop_plot$Cluster <- factor(prop_plot$Cluster, levels = levels(malignant$RNA_snn_res.0.3))
head(prop_plot)

getPalette <- colorRampPalette(brewer.pal(9, 'Set1'))
ggplot(prop_plot, aes(variable, value, fill = Cluster)) +
  geom_bar(stat = 'identity', position = 'stack') +
  scale_fill_manual(values = getPalette(8)[-8]) +
  labs(x = '', y = 'Proportion (%)') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(color = 'black'),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.ticks = element_line(color = 'black'))
#ggsave('../res_various/res_0.3/cluster_proportion/prop.clustering.pdf', unit = 'cm', width = 12, height = 8)


### Proportions of cell types
full_label <- subset(full_label,  Class == 'Tumor')
full_label <- subset(full_label, Patient != 'SMC05') # minor library
summary(full_label$Cell_type_v2)

full_label <- subset(full_label, Cell_type_v2 != 'Mast cells') # only three cells in tumor samples
summary(full_label$Cell_type_v2)

full_label <- droplevels(full_label)

prop_ct <- data.frame(matrix(nrow = length(unique(full_label$Cell_type_v2)), ncol = length(unique(full_label$Patient))))
colnames(prop_ct) <- levels(full_label$Patient)
rownames(prop_ct) <- levels(full_label$Cell_type_v2)
head(prop_ct)

for (pt in levels(full_label$Patient)) {
  summ <- summary(subset(full_label, Patient == pt)$Cell_type_v2)
  prop_ct[, pt] <- round(summ/sum(summ)*100, digits = 2)
}
prop_ct

prop_ct_plot <- data.frame(Cell_type = rownames(prop_ct), prop_ct)
prop_ct_plot <- melt(prop_ct_plot)
prop_ct_plot$Cell_type <- factor(prop_ct_plot$Cell_type, levels = c("Malignant cells", "Macrophages", "cDC", "B cells", "Plasma cells", "T cells", "Fibroblasts", "Stromal cells", "Endothelial cells"))
head(prop_ct_plot)

ggplot(prop_ct_plot, aes(variable, value, fill = Cell_type)) +
  geom_bar(stat = 'identity', position = 'stack') +
  scale_fill_manual(values = c("Malignant cells" = "#ED6345", "Macrophages" = "#F99455", "cDC" = "#FDC271", 
                               "B cells" = "#FFFFBF", "Plasma cells" = "#EBF79F", "T cells" = "#C2E69F", 
                               "Fibroblasts" = "#8FD2A4", "Stromal cells" = "#5BB6A9", "Endothelial cells" = "#3288BD")) +
  labs(x = '', y = 'Proportion (%)') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(color = 'black'),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.ticks = element_line(color = 'black'))
#ggsave('../res_various/res_0.3/cluster_proportion/prop.celltype.tumor.pdf', unit = 'cm', width = 14, height = 8)


### Correlation between malignant clusters and cell types
library(pheatmap)

cor(t(prop), t(prop_ct), method = 'pearson')
min(cor(t(prop), t(prop_ct), method = 'pearson'))
max(cor(t(prop), t(prop_ct), method = 'pearson'))

pheatmap(cor(t(prop), t(prop_ct), method = 'pearson'), #filename = '../res_various/res_0.3/cluster_proportion/corr.proportions.pdf',
         treeheight_row = 5, treeheight_col = 5, border_color = NA,
         fontsize_col = 9, fontsize_row = 9, cellwidth = 9, cellheight = 9,
         breaks = c(-0.6, -0.5, -0.4, -0.3, -0.2, -0.1, 0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6),
         color = colorRampPalette(c("#3a5fcd", 'white', "#ee0000"))(n = 12))
#dev.off()


```

